from __future__ import annotations

import re
from math import sqrt

import numpy as np
from matplotlib import pyplot as plt
from pint import UnitRegistry, Quantity

ureg = UnitRegistry()


def visualize(matrix: COSY_Matrix):
	E = np.linspace(10.7, 14.2, 21)*ureg("MeV")
	print(E)
	x = np.zeros(E.size)*ureg("m")
	for i, e in enumerate(E):
		x[i] = matrix.value("x", [0*ureg("m"), 0*ureg("rad"), 0*ureg("m"), 0*ureg("rad"), 0*ureg("s"), e - E0])
	print(x)
	plt.plot(E.to("MeV").m, x.to("cm").m)
	plt.xlabel("Energy (MeV)")
	plt.ylabel("Position (cm)")
	plt.grid("on")
	plt.tight_layout()
	plt.show()


E0 = 12.45*ureg("MeV")
m0 = 2.014*ureg("Da")
z0 = 1*ureg("e")
v0 = np.sqrt(2*E0/m0)
ɣ = 1/sqrt(1 - v0**2/ureg.speed_of_light**2)
cosy_coordinates = "xaybld"
cosy_units = [ureg("m"), ureg("rad"), ureg("m"), ureg("rad"), -ureg("m")*(1 + ɣ)/(ɣ*v0), E0, m0, z0, ureg("")]

class COSY_Matrix:
	def __init__(self, printout: str):
		self.rows: dict[tuple[int], tuple[Quantity]] = {}
		for line in printout.splitlines():
			blank_match = re.fullmatch(r"\s*", line)
			row_match = re.fullmatch(r"\s*([0-9E.+-]+)\s+([0-9E.+-]+)\s+([0-9E.+-]+)\s+([0-9E.+-]+)\s+([0-9E.+-]+)\s+([0-9]{9})", line)
			if blank_match:
				pass
			elif row_match:
				input_index = []
				input_unit = ureg("")
				for i, numeral in enumerate(row_match.group(6)):
					input_index.append(int(numeral))
					input_unit *= cosy_units[i]**int(input_index[i])
				coefficients = []
				for i in range(5):
					coefficient_unit = cosy_units[i]/input_unit
					coefficients.append(float(row_match.group(1 + i))*coefficient_unit)
				self.rows[tuple(input_index)] = tuple(coefficients)

	def coefficient(self, output: str, inputs: str) -> float:
		output_index = cosy_coordinates.index(output)
		input_index = [0]*9
		for inpoot in inputs:
			input_index[cosy_coordinates.index(inpoot)] += 1
		if tuple(input_index) in self.rows:
			return self.rows[tuple(input_index)][output_index]
		else:
			return 0.

	def value(self, output: str, inputs: list[Quantity]) -> float:
		value = 0.*cosy_units[cosy_coordinates.index(output)]
		for input_orders, coefficients in self.rows.items():
			term = coefficients[cosy_coordinates.index(output)]
			for coordinate, position, order in zip(cosy_coordinates, inputs, input_orders):
				term *= position**order
			value += term
		return value


if __name__ == "__main__":
	matrix = COSY_Matrix("""
  0.6626493      1.407174     0.0000000E+00 0.0000000E+00 0.4737754     100000000
  0.0000000E+00  1.509094     0.0000000E+00 0.0000000E+00 0.4001545     010000000
  0.0000000E+00 0.0000000E+00 -1.654076     -1.575508     0.0000000E+00 001000000
  0.0000000E+00 0.0000000E+00 -3.021505     -3.482552     0.0000000E+00 000100000
  0.0000000E+00 0.0000000E+00 0.0000000E+00 0.0000000E+00  1.000000     000010000
  0.2651621    -0.1518845     0.0000000E+00 0.0000000E+00  1.521395     000001000
  -12.72898     -11.49856     0.0000000E+00 0.0000000E+00 -6.015784     200000000
  -48.93014     -45.92893     0.0000000E+00 0.0000000E+00 -22.35642     110000000
  -48.32520     -46.90548     0.0000000E+00 0.0000000E+00 -22.39041     020000000
  0.0000000E+00 0.0000000E+00 -49.11845     -18.40120     0.0000000E+00 101000000
  0.0000000E+00 0.0000000E+00 -102.8437     -36.79388     0.0000000E+00 011000000
   33.52054      35.75714     0.0000000E+00 0.0000000E+00 -1.624817     002000000
  0.0000000E+00 0.0000000E+00 -124.8456     -49.11323     0.0000000E+00 100100000
  0.0000000E+00 0.0000000E+00 -259.2823     -97.64712     0.0000000E+00 010100000
   163.6649      173.3145     0.0000000E+00 0.0000000E+00 -11.56565     001100000
   201.4199      211.6355     0.0000000E+00 0.0000000E+00 -18.74094     000200000
  -1.819686    -0.7450110     0.0000000E+00 0.0000000E+00-0.6656636E-01 100001000
  -3.463004     -3.209801     0.0000000E+00 0.0000000E+00-0.4477841     010001000
  0.0000000E+00 0.0000000E+00  38.38154      16.97348     0.0000000E+00 001001000
  0.0000000E+00 0.0000000E+00  99.93626      45.38494     0.0000000E+00 000101000
  0.3079033     0.3464749     0.0000000E+00 0.0000000E+00 -1.216410     000002000
   41.30609      26.74900     0.0000000E+00 0.0000000E+00  22.92110     300000000
   231.2377      142.4322     0.0000000E+00 0.0000000E+00  120.0767     210000000
   424.4251      249.7595     0.0000000E+00 0.0000000E+00  206.2075     120000000
   255.5426      144.4441     0.0000000E+00 0.0000000E+00  114.3452     030000000
  0.0000000E+00 0.0000000E+00 -546.6619     -238.4558     0.0000000E+00 201000000
  0.0000000E+00 0.0000000E+00 -1065.099     -431.8670     0.0000000E+00 111000000
  0.0000000E+00 0.0000000E+00 -300.5645     -76.69818     0.0000000E+00 021000000
   208.6360     -51.52321     0.0000000E+00 0.0000000E+00 -41.08493     102000000
   23.81162     -296.0154     0.0000000E+00 0.0000000E+00 -14.92691     012000000
  0.0000000E+00 0.0000000E+00 -37360.51     -16831.52     0.0000000E+00 003000000
  0.0000000E+00 0.0000000E+00 -1541.385     -683.2356     0.0000000E+00 200100000
  0.0000000E+00 0.0000000E+00 -3293.939     -1392.107     0.0000000E+00 110100000
  0.0000000E+00 0.0000000E+00 -1342.514     -482.3018     0.0000000E+00 020100000
   1259.462     -94.34611     0.0000000E+00 0.0000000E+00 -213.9900     101100000
   489.0731     -1177.349     0.0000000E+00 0.0000000E+00 -105.1231     011100000
  0.0000000E+00 0.0000000E+00 -286273.3     -128985.0     0.0000000E+00 002100000
   1857.180      95.84750     0.0000000E+00 0.0000000E+00 -281.8730     100200000
   1101.787     -1069.752     0.0000000E+00 0.0000000E+00 -173.5795     010200000
  0.0000000E+00 0.0000000E+00 -731211.2     -329496.6     0.0000000E+00 001200000
  0.0000000E+00 0.0000000E+00 -622589.3     -280584.0     0.0000000E+00 000300000
  0.4298442E-01 -8.635058     0.0000000E+00 0.0000000E+00  4.778421     200001000
   33.35595     -3.607838     0.0000000E+00 0.0000000E+00  28.11959     110001000
   64.31286      25.62192     0.0000000E+00 0.0000000E+00  37.32705     020001000
  0.0000000E+00 0.0000000E+00  195.9257      86.66027     0.0000000E+00 101001000
  0.0000000E+00 0.0000000E+00  189.5077      71.16635     0.0000000E+00 011001000
  -181.2088     -103.2769     0.0000000E+00 0.0000000E+00  55.83344     002001000
  0.0000000E+00 0.0000000E+00  681.5698      300.5140     0.0000000E+00 100101000
  0.0000000E+00 0.0000000E+00  860.6890      346.8062     0.0000000E+00 010101000
  -1001.135     -609.9639     0.0000000E+00 0.0000000E+00  280.5292     001101000
  -1369.227     -874.4571     0.0000000E+00 0.0000000E+00  356.2735     000201000
   5.011732      2.611416     0.0000000E+00 0.0000000E+00-0.9035528     100002000
   10.71022      6.409301     0.0000000E+00 0.0000000E+00 -1.030457     010002000
  0.0000000E+00 0.0000000E+00 -121.0004     -47.58202     0.0000000E+00 001002000
  0.0000000E+00 0.0000000E+00 -355.0832     -142.7608     0.0000000E+00 000102000
  -1.055766    -0.6527156     0.0000000E+00 0.0000000E+00  1.174727     000003000
	""")
	visualize(matrix)
